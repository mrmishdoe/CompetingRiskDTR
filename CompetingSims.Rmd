---
title: "CompetingSims"
author: "Misha Dolmatov"
date: "2023-12-07"
output: html_document
---

```{r, include=FALSE}
library(tidyverse)
library(ggpubr)

source("RandomEffectsAFT.R")
```


```{r test }
source("RandomEffectsAFT.R")

#Gives similar performance but not great for ei
psi1 = c(0.4, -0.4)
psi2 = c(0.4, 0.4)
test = sim_data(1000, psi1, psi2, cens = F)
hist(test$Y)




```


```{r baseline scenario, message = F, warning = F}
#Baseline scenario with high POT, high value for both regimes
psi1 = c(0.2, -0.2)
psi2 = c(0.2, 0.2)

models = list(both = list(treat = a~x, cens = delta~x, out = log(Y)~ x+ a+a:x), treat = list(treat = a~x, cens = delta~x, out = log(Y)~ x+z+ a+a:x), 
                out = list(treat = a~x+z, cens = delta~x+z, out = log(Y)~ x+ a+a:x), none = list(treat = a~x+z, cens = delta~x+z, out = log(Y)~ x+z+ a+a:x))

n_train = 1000
n_test = 1000

set.seed(2024)
res_b = simAFT(100, n_train, n_test, psi1, psi2, models)

print_res(res_b, "baseline", save = F, boxplot = F)
```

```{r baseline scenario 2, message = F, warning = F}
#Baseline scenario with high POT, high value for both regimes
psi1 = c(0.2, -0.2)
psi2 = c(0.2, 0.2)

models = list(both = list(treat = a~x, cens = delta~x, out = log(Y)~ x+ a+a:x), treat = list(treat = a~x, cens = delta~x, out = log(Y)~ x+z+ a+a:x), 
                out = list(treat = a~x+z, cens = delta~x+z, out = log(Y)~ x+ a+a:x), none = list(treat = a~x+z, cens = delta~x+z, out = log(Y)~ x+z+ a+a:x))

#5x sample size so approx half the SE
n_train = 5000
n_test = 10000

set.seed(2024)
res_b2 = simAFT(100, n_train, n_test, psi1, psi2, models)

print_res(res_b2, "baseline2", save = T, boxplot = T)
```

```{r scenario 1, warning=F,fig.width= 10, fig.height=10}

#First scenario, weighted performs best
#Opposite strategies for both causes, always treat for one cause, never treat for the other
#Smaller POT but much higher value

psi1 = c(3, -0.5)
psi2 = c(-1, 0.2)

models = list(none = list(treat = a~x+z, cens = delta~x+z, out = log(Y)~ x+z+ a+a:x))

set.seed(2024)
res_s1 = simAFT(100, 1000, 1000, psi1, psi2, models)

#Save output
saveRDS(res_s1, file = "raw_results/s1.rds")

res_s1$none$blip_plot
res_s1$none$measures
#ggsave("blip.png", r, width=12, height = 12)
```


```{r scenario 2, warning=F, fig.width= 10, fig.height=10}

#Scenario 2 : Greedy performs the best
#When one cause is more likely and the less likely cause does not have very negative blips
#Much higher POT but value a bit smaller

psi1= c(-0.5, -0.7)
psi2= c(0.1, 0.08)

models = list(none = list(treat = a~x+z, cens = delta~x+z, out = log(Y)~ x+z+ a+a:x))

set.seed(2024)
res_s2 = simAFT(100, 1000, 1000, psi1, psi2, models)

#Save output
saveRDS(res_s2, file = "raw_results/s2.rds")

res_s2$none$blip_plot
res_s2$none$measures
#ggsave("blip.png", r, width=12, height = 12)

```

```{r scenario 3 same slopes & perform similar}
#Need to pick values that do not have that much variance, so that the actual differences are more apparent

#Scenario 3 : Same slopes and similar performance for both regimes

# psi1 = c(-0.2, 0.3)
# psi2 = c(0.4, -0.4)

psi1= c(0.6,-0.6)
psi2= c(-0.6, -0.6)

models = list(none = list(treat = a~x+z, cens = delta~x+z, out = log(Y)~ x+z+ a+a:x))

set.seed(2024)
res_s3 = simAFT(100,1000, 1000, psi1, psi2, models, total_var = 1)

#Save output
saveRDS(res_s3, file = "raw_results/s3.rds")

res_s3$none$blip_plot
res_s3$none$measures
res_s3$none$inference
#ggsave("blip.png", r, width=12, height = 12)


```


```{r scenario 4 different ICC, warning = F, message = F}

#Scenario 4: Different ICC
#Maybe change ICC but make the sum of random effect and aft variances equal so total variance is the same
# now we go ICC approx 0.9, which corresponds to sd of 0.67 and 0.22 for re and model respectively

psi1= c(0.6,-0.6)
psi2= c(-0.6, -0.6)

models = list(none = list(treat = a~x+z, cens = delta~x+z, out = log(Y)~ x+z+ a+a:x))

set.seed(2024)
res_s4_1 = simAFT(100, 1000, 1000, psi1, psi2, models,total_var = 1 , ICC = 0.9)

#Save output
saveRDS(res_s4_1, file = "raw_results/s4_1.rds")

res_s4_1$none$blip_plot
res_s4_1$none$measures
res_s4_1$none$inference
#ggsave("blip.png", r, width=12, height = 12)


set.seed(2024)
res_s4_2 = simAFT(100, 1000, 1000, psi1, psi2, models,total_var = 1 , ICC = 0.1)

#Save output
saveRDS(res_s4_2, file = "raw_results/s4_2.rds")

res_s4_2$none$blip_plot
res_s4_2$none$measures
res_s4_2$none$inference
```

```{r scenario 5 different error distribution}

#Scenario 5: Different error distribution
#Gonna use centered gamma distribution with beta = 1 and alpha = 0.25, rgamma(n, shape = 0.25) - 0.25
#Same POT and blip plots, with higher value because right skewed

psi1= c(0.6,-0.6)
psi2= c(-0.6, -0.6)

models = list(none = list(treat = a~x+z, cens = delta~x+z, out = log(Y)~ x+z+ a+a:x))

set.seed(2024)
res_s5 = simAFT(100,1000, 1000, psi1, psi2, models, total_var = 1, re_dist = "gamma")

#Save output
saveRDS(res_s5, file = "raw_results/s5.rds")

res_s5$none$blip_plot
res_s5$none$measures
res_s5$none$inference
```

```{r scenario 6 different level of censoring}

#Scenario 6: 50% censoring instead of 20%
#Variance increases
psi1= c(0.6,-0.6)
psi2= c(-0.6, -0.6)

models = list(none = list(treat = a~x+z, cens = delta~x+z, out = log(Y)~ x+z+ a+a:x))

set.seed(2024)
res_s6 = simAFT(100,1000, 1000, psi1, psi2, models, total_var = 1, cens_low = F)

#Save output
saveRDS(res_s6, file = "raw_results/s6.rds")

res_s6$none$blip_plot
res_s6$none$measures
res_s6$none$inference
```

```{r scenario 7 ignoring clustering}
#Scenario 7: ignoring clustering i.e. use independence structure in GEE over exchangeable
#Variance should increase

psi1= c(0.6,-0.6)
psi2= c(-0.6, -0.6)

models = list(none = list(treat = a~x+z, cens = delta~x+z, out = log(Y)~ x+z+ a+a:x))

set.seed(2024)
res_s7 = simAFT(100,1000, 1000, psi1, psi2, models, total_var = 1, corstr = "independence")

#Save output
saveRDS(res_s7, file = "raw_results/s7.rds")

res_s7$none$blip_plot
res_s7$none$measures
res_s7$none$inference
#ggsave("blip.png", r, width=12, height = 12)

```

```{r scenario 8 clustering in the treatment allocation}
#Scenario : ignoring treatment clustering
#Do 3 different levels of clustering
psi1= c(0.6,-0.6)
psi2= c(-0.6, -0.6)

models = list(none = list(treat = a~x+z, cens = delta~x+z, out = log(Y)~ x+z+ a+a:x))

set.seed(2024)
res_s8_1 = simAFT(100,1000, 1000, psi1, psi2, models, total_var = 1, treat_clust = T)

#Save output
saveRDS(res_s8_1, file = "raw_results/s8_1.rds")

res_s8_1$none$blip_plot
res_s8_1$none$measures
res_s8_1$none$inference
#ggsave("blip.png", r, width=12, height = 12)

#Large random effect
set.seed(2024)
res_s8_2 = simAFT(100,1000, 1000, psi1, psi2, models, total_var = 1, treat_clust = T, treat_re = "high")

#Save output
saveRDS(res_s8_2, file = "raw_results/s8_2.rds")

res_s8_2$none$blip_plot
res_s8_2$none$measures
res_s8_2$none$inference

#Low random effect
set.seed(2024)
res_s8_3 = simAFT(100,1000, 1000, psi1, psi2, models, total_var = 1, treat_clust = T, treat_re = "low")

#Save output
saveRDS(res_s8_3, file = "raw_results/s8_3.rds")

res_s8_3$none$blip_plot
res_s8_3$none$measures
res_s8_3$none$inference
```


```{r testing param estimation}

psi1= c(0.6,-0.6)
psi2= c(-0.6, -0.6)

set.seed(2024)
dat = sim_data(2000, psi1, psi2, total_var = 1, ICC = 0.9, nclust = 50)

aft2 = function(data, treat.mod, cens.mod, outcome.mod, cause){
  
  #Treatment model and censoring model 
  treat_mod = glm(treat.mod, data = data, family = binomial)
  cens_mod = glm(cens.mod, data = data, family = binomial)
  
  treat_prob = predict(treat_mod, type = "response")
  cens_prob = predict(cens_mod, type = "response")
  
  #Weights are wrong for censored observations but doesent matter since they are excluded
  weights = abs(data$a - treat_prob)/cens_prob
  
  #Estimation of blip parameters via random effects AFT model
  index = with(data, epsilon == cause & delta == 1)
  data = data[index,]
  w = weights[index]
  
  data = data %>% mutate(w = w)
  
  #Fitting GEE with exchangeable correlation structure, geeM package requires data.frame
  
  data = data %>% arrange(group) %>% as.data.frame()
  model = geem(formula = outcome.mod, data = data, weights = w, id = group, corstr = "exchangeable")
  
  model
  #coefs = coef(model)
  
  #coefs[grepl("a", names(coefs), fixed = T)]
}

m = list(treat = a~x+z, cens = delta~x+z, out = log(Y)~ x+ a+a:x)

mod1 = aft2(dat, m$treat, m$cens, m$out, 1)
mod2 = aft2(dat, m$treat, m$cens, m$out, 2)

summary(mod1)
summary(mod2)

temp = dat %>% filter(epsilon == 1 & delta == 1)
ggplot(data = temp) + geom_boxplot(aes(x = group, y = log(Y)))
```


